name: Codex Doc Sync

on:
  workflow_call:
    inputs:
      doc_globs:
        description: |-
          Newline-separated glob patterns that define documentation files (e.g., docs/**, **/*.md, README*).
        required: false
        type: string
        default: |
          docs/**
          **/*.md
          README*
      comment_on_update:
        description: Post a pull request comment whenever docs were updated.
        required: false
        type: boolean
        default: true
      safety_strategy:
        description: Safety strategy passed to Codex (drop-sudo/read-only/unprivileged-user/unsafe).
        required: false
        type: string
        default: drop-sudo
      model:
        description: Optional Codex model override.
        required: false
        type: string
        default: ""
      effort:
        description: Optional Codex reasoning effort override.
        required: false
        type: string
        default: ""
      codex_args:
        description: Additional arguments passed to codex exec (JSON array or shell string).
        required: false
        type: string
        default: ""
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-doc-sync-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  docs:
    if: github.event.pull_request != null || github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    env:
      DOC_REPORT_PATH: doc-sync-report.md
    steps:
      - name: Resolve pull request context
        id: pr_context
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const repoFull = `${owner}/${repo}`;

            let pr = context.payload.pull_request;
            if (!pr && context.payload.issue?.pull_request) {
              const response = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: context.payload.issue.number,
              });
              pr = response.data;
            }

            if (!pr) {
              core.setOutput('proceed', 'false');
              core.info('No pull request context detected in this event.');
              return;
            }

            const headRepoFull = pr.head.repo?.full_name || '';
            const sameRepo = headRepoFull === repoFull;
            if (!sameRepo) {
              core.info(`Head repository ${headRepoFull || '(unknown)'} differs from ${repoFull}; skipping to avoid pushing to forks.`);
            }

            core.setOutput('proceed', sameRepo ? 'true' : 'false');
            core.setOutput('number', String(pr.number));
            core.setOutput('base_ref', pr.base?.ref || '');
            core.setOutput('head_ref', pr.head?.ref || '');
            core.setOutput('head_sha', pr.head?.sha || '');

      - name: Checkout target repository
        if: steps.pr_context.outputs.proceed == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.pr_context.outputs.head_sha }}

      - name: Fetch base reference
        if: steps.pr_context.outputs.proceed == 'true'
        run: git fetch --no-tags origin ${{ steps.pr_context.outputs.base_ref }}

      - name: Collect commit summary
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          git log --no-merges --pretty=format:'- %s (%h)' \
            origin/${{ steps.pr_context.outputs.base_ref }}..${{ steps.pr_context.outputs.head_sha }} > doc-commits.md
          if [ ! -s doc-commits.md ]; then
            echo "- No commits detected between base and head." > doc-commits.md
          fi

      - name: Ignore doc summary file
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          mkdir -p .git/info
          if ! grep -qx "$DOC_REPORT_PATH" .git/info/exclude 2>/dev/null; then
            echo "$DOC_REPORT_PATH" >> .git/info/exclude
          fi

      - name: Checkout shared workflow assets
        if: steps.pr_context.outputs.proceed == 'true'
        uses: actions/checkout@v5
        with:
          repository: activadee/codex-shared-workflows
          ref: main
          path: __codex_shared

      - name: Write documentation scope manifest
        if: steps.pr_context.outputs.proceed == 'true'
        env:
          DOC_GLOBS: ${{ inputs.doc_globs }}
          DOC_GLOBS_PATH: doc-globs.txt
        run: node __codex_shared/.github/scripts/doc-sync/write_doc_globs.js

      - name: Prepare Codex prompt
        if: steps.pr_context.outputs.proceed == 'true'
        env:
          BASE_REF: ${{ steps.pr_context.outputs.base_ref }}
          PR_NUMBER: ${{ steps.pr_context.outputs.number }}
          REPORT_PATH: ${{ env.DOC_REPORT_PATH }}
          TEMPLATE_PATH: __codex_shared/.github/prompts/codex-doc-sync.md
          DOC_GLOBS_PATH: doc-globs.txt
          PROMPT_PATH: codex_prompt.md
          COMMITS_PATH: doc-commits.md
        run: node __codex_shared/.github/scripts/doc-sync/prepare_prompt.js

      - name: Run Codex doc sync
        if: steps.pr_context.outputs.proceed == 'true'
        id: run_codex
        uses: activadee/codex-action@main
        env:
          DOC_REPORT_PATH: ${{ env.DOC_REPORT_PATH }}
          DOC_BASE_REF: ${{ steps.pr_context.outputs.base_ref }}
          DOC_HEAD_REF: ${{ steps.pr_context.outputs.head_ref }}
          DOC_HEAD_SHA: ${{ steps.pr_context.outputs.head_sha }}
          DOC_PR_NUMBER: ${{ steps.pr_context.outputs.number }}
          DOC_GLOBS: ${{ inputs.doc_globs }}
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt-file: codex_prompt.md
          safety-strategy: ${{ inputs.safety_strategy }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          codex-args: ${{ inputs.codex_args }}

      - name: Detect documentation changes
        if: steps.pr_context.outputs.proceed == 'true'
        id: detect_docs
        run: |
          node __codex_shared/.github/scripts/doc-sync/detect_doc_changes.js \
            --globs-file doc-globs.txt \
            --output doc-changes.txt
          if [ -s doc-changes.txt ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Docs already up to date
        if: steps.pr_context.outputs.proceed == 'true' && steps.detect_docs.outputs.changed == 'false'
        run: cat "$DOC_REPORT_PATH" 2>/dev/null || echo "Documentation already matched the code changes."

      - name: Commit documentation updates
        if: steps.pr_context.outputs.proceed == 'true' && steps.detect_docs.outputs.changed == 'true'
        id: commit_docs
        env:
          PR_NUMBER: ${{ steps.pr_context.outputs.number }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add --pathspec-from-file=doc-changes.txt
          git commit -m "[skip ci][doc-sync] Auto-update docs for PR #${PR_NUMBER}"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Push documentation updates
        if: steps.pr_context.outputs.proceed == 'true' && steps.detect_docs.outputs.changed == 'true'
        run: git push origin HEAD:${{ steps.pr_context.outputs.head_ref }}

      - name: Comment on pull request
        if: steps.pr_context.outputs.proceed == 'true' && steps.detect_docs.outputs.changed == 'true' && inputs.comment_on_update
        uses: actions/github-script@v7
        env:
          REPORT_PATH: ${{ env.DOC_REPORT_PATH }}
          DOC_COMMIT_SHA: ${{ steps.commit_docs.outputs.sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = process.env.REPORT_PATH;
            let summary = '';
            try {
              summary = fs.readFileSync(path, 'utf8').trim();
            } catch (error) {
              summary = 'Documentation was updated automatically to reflect the latest code changes.';
            }
            let files = '- (unknown)';
            try {
              const list = fs.readFileSync('doc-changes.txt', 'utf8')
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean);
              if (list.length) {
                files = list.map((item) => `- ${item}`).join('\n');
              }
            } catch (error) {
              // ignore, fallback remains
            }
            const commitSha = process.env.DOC_COMMIT_SHA || '';
            const body = [
              'ðŸ¤– Documentation synchronized automatically.',
              '',
              summary,
              '',
              'Updated files:',
              files,
              '',
              commitSha ? `Commit: ${commitSha}` : '',
            ].filter(Boolean).join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
