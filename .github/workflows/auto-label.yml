name: Codex Auto Label Issues

on:
  workflow_call:
    inputs:
      max_labels:
        description: Maximum number of labels to apply (1-3).
        required: false
        type: number
        default: 3
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

jobs:
  label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v5

      - name: Checkout shared workflow assets
        uses: actions/checkout@v5
        with:
          repository: activadee/codex-shared-workflows
          ref: main
          path: __codex_shared

      - name: Prepare Codex auto-label assets
        id: prepare
        uses: ./__codex_shared/.github/actions/auto-label-prepare
        with:
          max-labels: ${{ inputs.max_labels }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate labels with Codex
        id: run_codex
        uses: activadee/codex-action@main
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          safety-strategy: drop-sudo
          prompt-file: codex_prompt.md
          output-file: codex-output.json
          output-schema: ${{ steps.prepare.outputs.codex-output-schema }}
          model: gpt-5
          effort: medium

      - name: Apply labels
        uses: ./__codex_shared/.github/actions/auto-label-apply
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          max-labels: ${{ steps.prepare.outputs.max-labels }}
